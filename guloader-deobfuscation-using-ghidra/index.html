<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Guloader Deobfuscation using Ghidra - irfan_eternal</title><meta name=Description content="Guloader Deobfuscation using Ghidra"><meta property="og:title" content="Guloader Deobfuscation using Ghidra"><meta property="og:description" content="Guloader Deobfuscation using Ghidra"><meta property="og:type" content="article"><meta property="og:url" content="https://irfan-eternal.github.io/guloader-deobfuscation-using-ghidra/"><meta property="og:image" content="https://irfan-eternal.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-23T11:35:00+08:00"><meta property="article:modified_time" content="2023-07-28T11:43:45-04:00"><meta property="og:site_name" content="irfan_eternal"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://irfan-eternal.github.io/logo.png"><meta name=twitter:title content="Guloader Deobfuscation using Ghidra"><meta name=twitter:description content="Guloader Deobfuscation using Ghidra"><meta name=application-name content="irfan_eternal"><meta name=apple-mobile-web-app-title content="irfan_eternal"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://irfan-eternal.github.io/guloader-deobfuscation-using-ghidra/><link rel=prev href=https://irfan-eternal.github.io/malware-string-decryption-in-2-ways/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Guloader Deobfuscation using Ghidra","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/irfan-eternal.github.io\/guloader-deobfuscation-using-ghidra\/"},"image":[{"@type":"ImageObject","url":"https:\/\/irfan-eternal.github.io\/images\/Apple-Devices-Preview.png","width":3200,"height":2048}],"genre":"posts","wordcount":946,"url":"https:\/\/irfan-eternal.github.io\/guloader-deobfuscation-using-ghidra\/","datePublished":"2023-07-23T11:35:00+08:00","dateModified":"2023-07-28T11:43:45-04:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"irfan_eternal","logo":{"@type":"ImageObject","url":"https:\/\/irfan-eternal.github.io\/images\/avatar.png","width":400,"height":400}},"author":{"@type":"Person","name":"irfan_eternal"},"description":"Guloader Deobfuscation using Ghidra"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=irfan_eternal>irfan_eternal</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About Me </a><a class=menu-item href=https://github.com/irfan-eternal title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><a class=menu-item href=/></a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=irfan_eternal>irfan_eternal</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About Me</a><a class=menu-item href=https://github.com/irfan-eternal title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a class=menu-item href=/ title></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Guloader Deobfuscation using Ghidra</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://twitter.com/irfan_eternal title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>irfan_eternal</a></span>&nbsp;<span class=post-category>included in <a href=/categories/malware-analysis/><i class="far fa-folder fa-fw" aria-hidden=true></i>Malware Analysis</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-07-23>2023-07-23</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;946 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;5 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#anti-analysis--obfuscation>Anti-Analysis / Obfuscation</a><ul><li><a href=#api-hashing>API Hashing</a></li><li><a href=#checks-before-calling-apis>Checks before Calling API&rsquo;s</a></li><li><a href=#control-flow-obfuscation-using-vectored-exception-handling>Control Flow Obfuscation using Vectored Exception Handling</a></li><li><a href=#encrypted-strings>Encrypted Strings</a></li></ul></li><li><a href=#automation-using-ghidra-apis>Automation using Ghidra API&rsquo;s</a></li><li><a href=#references>References</a></li></ul></nav></div></div><div class=content id=content><h2 id=introduction>Introduction</h2><p>Hi all, Today we will be Analyzing Guloader Shellcode using Ghidra. Our Objective is to Identify some Anti-analysis and Obfuscation techniques used by Guloader and Defeat it using Automation. People who would like to follow along can download the sample from <a href=https://bazaar.abuse.ch/sample/55130719554a0b3dcbf971c646e6e668b663b796f4be09816d405cc15a16d7d6/ target=_blank rel="noopener noreffer">here</a> . The File was was seen on 2023-05-11</p><h2 id=anti-analysis--obfuscation>Anti-Analysis / Obfuscation</h2><h3 id=api-hashing>API Hashing</h3><p>The Shellcode is using API hashing to hide API&rsquo;s being called. For Each API Resolving it first resolves <a href=https://malapi.io/winapi/LdrLoadDll target=_blank rel="noopener noreffer">LdrLoadDll</a> add 5 to it&rsquo;s address to avoid any Hooking done by EDR .Adding 5 to the API address is to avoid the classic 5 Byte Hook.Most EDR replaces first first bytes with a jump to EDR&rsquo;s code. It then use this address to Load the DLL. after Loading the DLL . it resolves the hash of the API it needs to call
<img class=lazyload src=/svg/loading.min.svg data-src=/guloader-deobfuscation-using-ghidra/resolve_api.PNG data-srcset="/guloader-deobfuscation-using-ghidra/resolve_api.PNG, /guloader-deobfuscation-using-ghidra/resolve_api.PNG 1.5x, /guloader-deobfuscation-using-ghidra/resolve_api.PNG 2x" data-sizes=auto alt=/guloader-deobfuscation-using-ghidra/resolve_api.PNG title=api_resolving width=758 height=744></p><p>API Hashing function is the same as we see in the wild. it goes to the Export Directory of the DLL Loaded and performs Hashing of all API name&rsquo;s till the hashes match .if the hashes match it stores the Address of the API
<img class=lazyload src=/svg/loading.min.svg data-src=/guloader-deobfuscation-using-ghidra/hashed_api%27s.PNG data-srcset="/guloader-deobfuscation-using-ghidra/hashed_api%27s.PNG, /guloader-deobfuscation-using-ghidra/hashed_api%27s.PNG 1.5x, /guloader-deobfuscation-using-ghidra/hashed_api%27s.PNG 2x" data-sizes=auto alt="/guloader-deobfuscation-using-ghidra/hashed_api's.PNG" title=api_hashing width=755 height=780></p><p>Hashing Algorithm : In the past Guloader was using just DJB2 hash . Now it xors the result of djb2 hash with a hardcoded value to perform API Hashing
<img class=lazyload src=/svg/loading.min.svg data-src=/guloader-deobfuscation-using-ghidra/DJB2+XOR.PNG data-srcset="/guloader-deobfuscation-using-ghidra/DJB2+XOR.PNG, /guloader-deobfuscation-using-ghidra/DJB2+XOR.PNG 1.5x, /guloader-deobfuscation-using-ghidra/DJB2+XOR.PNG 2x" data-sizes=auto alt=/guloader-deobfuscation-using-ghidra/DJB2+XOR.PNG title=api_hashing width=763 height=722></p><p>I wrote a python script to identify the Hashes of the API&rsquo;s used by the past Guloaders to identify the Functionalities of the Code</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>val</span> <span class=o>=</span> <span class=mh>0x1505</span>
</span></span><span class=line><span class=cl><span class=n>APIstrings</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;NtGetContextThread&#34;</span><span class=p>,</span> <span class=s2>&#34;RtlAddVectoredExceptionHandler&#34;</span><span class=p>,</span> <span class=s2>&#34;NtAllocateVirtualMemory&#34;</span><span class=p>,</span> <span class=s2>&#34;DbgUIRemoteBreakIn&#34;</span><span class=p>,</span> <span class=s2>&#34;LdrLoadDll&#34;</span><span class=p>,</span> <span class=s2>&#34;DbgBreakPoint&#34;</span><span class=p>,</span> <span class=s2>&#34;EnumWindows&#34;</span><span class=p>,</span> <span class=s2>&#34;NtSetInformationThread&#34;</span><span class=p>,</span> <span class=s2>&#34;ZwSetInformationThread&#34;</span><span class=p>,</span> <span class=s2>&#34;TerminateProcess&#34;</span><span class=p>,</span> <span class=s2>&#34;ExitProcess&#34;</span><span class=p>,</span> <span class=s2>&#34;NtSetContextThread&#34;</span><span class=p>,</span> <span class=s2>&#34;NtWriteVirtualMemory&#34;</span><span class=p>,</span> <span class=s2>&#34;NtCreateSection&#34;</span><span class=p>,</span> <span class=s2>&#34;NtMapViewOfSection&#34;</span><span class=p>,</span> <span class=s2>&#34;NtOpenFile&#34;</span><span class=p>,</span> <span class=s2>&#34;NtSetInformationProcess&#34;</span><span class=p>,</span> <span class=s2>&#34;NtClose&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=s2>&#34;NtResumeThread&#34;</span><span class=p>,</span> <span class=s2>&#34;NtProtectVirtualMemory&#34;</span><span class=p>,</span> <span class=s2>&#34;CreateProcessInternal&#34;</span><span class=p>,</span> <span class=s2>&#34;GetLongPathNameW&#34;</span><span class=p>,</span> <span class=s2>&#34;Sleep&#34;</span><span class=p>,</span> <span class=s2>&#34;NtCreateThreadEx&#34;</span><span class=p>,</span> <span class=s2>&#34;WaitForSingleObject&#34;</span><span class=p>,</span> <span class=s2>&#34;TerminateThread&#34;</span><span class=p>,</span> <span class=s2>&#34;CreateFileW&#34;</span><span class=p>,</span> <span class=s2>&#34;WriteFile&#34;</span><span class=p>,</span><span class=s2>&#34;ReadFile&#34;</span><span class=p>,</span><span class=s2>&#34;ShellExecuteW&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=s2>&#34;RegCreateKeyExA&#34;</span><span class=p>,</span><span class=s2>&#34;RegSetValueExA&#34;</span><span class=p>,</span> <span class=s2>&#34;NtQueryInformationProcess&#34;</span><span class=p>,</span> <span class=s2>&#34;InternetOpenA&#34;</span><span class=p>,</span> <span class=s2>&#34;InternetSetOptionA&#34;</span><span class=p>,</span> <span class=s2>&#34;InternetOpenUrlA&#34;</span><span class=p>,</span> <span class=s2>&#34;InternetReadFile&#34;</span><span class=p>,</span> <span class=s2>&#34;InternetCloseHandle&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>APIstring</span> <span class=ow>in</span> <span class=n>APIstrings</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>val</span>  <span class=o>=</span> <span class=mh>0x1505</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>ch</span> <span class=ow>in</span> <span class=n>instring</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>val</span> <span class=o>+=</span> <span class=p>((</span><span class=n>val</span> <span class=o>&lt;&lt;</span><span class=mi>5</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=n>val</span> <span class=o>&amp;=</span> <span class=mh>0xFFFFFFFF</span>
</span></span><span class=line><span class=cl>        <span class=n>val</span> <span class=o>+=</span> <span class=nb>ord</span><span class=p>(</span><span class=n>ch</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>val</span> <span class=o>&amp;=</span> <span class=mh>0xFFFFFFFF</span>
</span></span><span class=line><span class=cl>        <span class=n>val</span> <span class=o>^=</span> <span class=mh>0x8131A1</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>APIstring</span><span class=o>+</span><span class=s2>&#34; :  &#34;</span><span class=o>+</span><span class=nb>hex</span><span class=p>(</span><span class=n>val</span><span class=p>))</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=checks-before-calling-apis>Checks before Calling API&rsquo;s</h3><p>Before Calling the API it performs some Checks to make sure it is not being Debugged
<img class=lazyload src=/svg/loading.min.svg data-src=/guloader-deobfuscation-using-ghidra/call_api%27s.PNG data-srcset="/guloader-deobfuscation-using-ghidra/call_api%27s.PNG, /guloader-deobfuscation-using-ghidra/call_api%27s.PNG 1.5x, /guloader-deobfuscation-using-ghidra/call_api%27s.PNG 2x" data-sizes=auto alt="/guloader-deobfuscation-using-ghidra/call_api's.PNG" title=call_api width=693 height=606></p><p>It compares the first few bytes of the API address with a) CC b) INT 3 c) UD2 to check if it&rsquo;s being Debugged. if this is not the case it calls the API
<img class=lazyload src=/svg/loading.min.svg data-src=/guloader-deobfuscation-using-ghidra/call_api_check_exception.PNG data-srcset="/guloader-deobfuscation-using-ghidra/call_api_check_exception.PNG, /guloader-deobfuscation-using-ghidra/call_api_check_exception.PNG 1.5x, /guloader-deobfuscation-using-ghidra/call_api_check_exception.PNG 2x" data-sizes=auto alt=/guloader-deobfuscation-using-ghidra/call_api_check_exception.PNG title=call_api2 width=759 height=608></p><h3 id=control-flow-obfuscation-using-vectored-exception-handling>Control Flow Obfuscation using Vectored Exception Handling</h3><p>To Obfuscate the Control Flow it uses RtlAddVectoredExceptionHandler to register a vectored Exception Handler. If the Exception raised is any of below three cases it changes the EIP by an XOR operation</p><ol><li>EXCEPTION_ACCESS_VIOLATION while accessed memory Address is 0</li><li>EXCEPTION_SINGLE_STEP (Single Stepping )</li><li>EXCEPTION_BREAKPOINT (Software Break Point - CC)</li></ol><p>If it is EXCEPTION_BREAKPOINT it calculates the value of the EIP by this expression EIP = EIP + *(EIP+1) ^ 6A (Changes with sample)</p><p>If it is EXCEPTION_ACCESS_VIOLATION or EXCEPTION_SINGLE_STEP it calculates the value of the EIP by this expression EIP = EIP + *(EIP+2) ^ 6A (Changes with sample) .
<img class=lazyload src=/svg/loading.min.svg data-src=/guloader-deobfuscation-using-ghidra/vectored_exception_handler.PNG data-srcset="/guloader-deobfuscation-using-ghidra/vectored_exception_handler.PNG, /guloader-deobfuscation-using-ghidra/vectored_exception_handler.PNG 1.5x, /guloader-deobfuscation-using-ghidra/vectored_exception_handler.PNG 2x" data-sizes=auto alt=/guloader-deobfuscation-using-ghidra/vectored_exception_handler.PNG title=veh width=616 height=629></p><p>In the Vectored Exception Handler function it also checks if any Dynamic anyalsis is being performed by Checking if any hardware breakpoint is set using ContextRecord a member of <a href=https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-exception_pointers target=_blank rel="noopener noreffer">_EXCEPTION_POINTERS</a>
<img class=lazyload src=/svg/loading.min.svg data-src=/guloader-deobfuscation-using-ghidra/vectored_exception_breakpoint_check.PNG data-srcset="/guloader-deobfuscation-using-ghidra/vectored_exception_breakpoint_check.PNG, /guloader-deobfuscation-using-ghidra/vectored_exception_breakpoint_check.PNG 1.5x, /guloader-deobfuscation-using-ghidra/vectored_exception_breakpoint_check.PNG 2x" data-sizes=auto alt=/guloader-deobfuscation-using-ghidra/vectored_exception_breakpoint_check.PNG title=veh width=657 height=264></p><p>To Understand Vectored Exception in Detail i would suggest to read this <a href=https://www.mcafee.com/blogs/other-blogs/mcafee-labs/guloader-campaigns-a-deep-dive-analysis-of-a-highly-evasive-shellcode-based-loader/ target=_blank rel="noopener noreffer">article</a></p><h3 id=encrypted-strings>Encrypted Strings</h3><p>All the Important strings including the C2 URL is Encrypted using XOR. The Encrypted strings are created by Performing a lot of Mathematical Expression(not Hardcoded).After Encryption String is Fully Created . The first Dword contains the length of the Encrypted string. then what follows is the Encrypted string. The Address of the Encrypted string is given as parameter to the String Decrpyion preperation Function. It store the Encrypted String length in a Varaible. And changes the First Dword to a Dummy Value . After that increments the Address of Encrypted String by a dword now it points to the Actual start of the String. Encrypted_string and the Encrypted String length is given an paramerers to the next Function called which is a wrapper around the string decryption function
<img class=lazyload src=/svg/loading.min.svg data-src=/guloader-deobfuscation-using-ghidra/string_decryption_prep.PNG data-srcset="/guloader-deobfuscation-using-ghidra/string_decryption_prep.PNG, /guloader-deobfuscation-using-ghidra/string_decryption_prep.PNG 1.5x, /guloader-deobfuscation-using-ghidra/string_decryption_prep.PNG 2x" data-sizes=auto alt=/guloader-deobfuscation-using-ghidra/string_decryption_prep.PNG title=dec-prep width=767 height=474></p><p>The wrapper function passes the Encrypted_string, Encrypted String length and the Key. The key is actually stored in the return address of the wrapper function
<img class=lazyload src=/svg/loading.min.svg data-src=/guloader-deobfuscation-using-ghidra/key_xor.PNG data-srcset="/guloader-deobfuscation-using-ghidra/key_xor.PNG, /guloader-deobfuscation-using-ghidra/key_xor.PNG 1.5x, /guloader-deobfuscation-using-ghidra/key_xor.PNG 2x" data-sizes=auto alt=/guloader-deobfuscation-using-ghidra/key_xor.PNG title=dec-wrap width=737 height=435></p><p>The Decrytion Algorithm is a Simple XOR were Encrypted string is calculated by Mathematical Expression and key is stored in the the return address of the wrapper function
<img class=lazyload src=/svg/loading.min.svg data-src=/guloader-deobfuscation-using-ghidra/literal_xor.PNG data-srcset="/guloader-deobfuscation-using-ghidra/literal_xor.PNG, /guloader-deobfuscation-using-ghidra/literal_xor.PNG 1.5x, /guloader-deobfuscation-using-ghidra/literal_xor.PNG 2x" data-sizes=auto alt=/guloader-deobfuscation-using-ghidra/literal_xor.PNG title=decryption width=734 height=482></p><h2 id=automation-using-ghidra-apis>Automation using Ghidra API&rsquo;s</h2><p>Analyzing the shellcode dynamically will be very tiring because it has multiple checks for Anti-Analysis . Static Analysis will also take much time due to Control Flow Obfusucation. So I wrote 2 Scripts to help in this Analysis . one is to Deobfuscate the Control Flow and the other is to Decrypt the Strings</p><p>Please Follow the Below Steps to Reduce your time on Guloader</p><ol><li>Import the Shellcode to Ghidra</li><li>Disassemble (Key Binding D) the Start of the Shell code</li><li>Run the <a href=https://github.com/irfan-eternal/blog_temp/blob/main/guloader/Guloader_deobfusucate.py target=_blank rel="noopener noreffer">Guloader_deobfusucate.py</a> script Providing the Decryption Key and key for EIP modification</li><li>Run the <a href=https://github.com/irfan-eternal/blog_temp/blob/main/guloader/Gu_string_decryption.py target=_blank rel="noopener noreffer">Gu_string_decryption.py</a> script Providing the Decryption Key</li></ol><p><strong>NOTE:</strong> For Both Cases Provide the keys as Hex String with out Ox Example if the key is 0x6A Provide it as 6A. My Scripts are not the best way to Achieve this . Note to Self need to improve to write better code</p><p>After these Steps the Control Flow will be Deobfusucated and Decrypted Strings and Payload key will be printed in the Console . If you have a closer look at the below image you will see the C2 URl will not be starting with http:// this is to prevent it from XOR Bruteforcing</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/guloader-deobfuscation-using-ghidra/result.png data-srcset="/guloader-deobfuscation-using-ghidra/result.png, /guloader-deobfuscation-using-ghidra/result.png 1.5x, /guloader-deobfuscation-using-ghidra/result.png 2x" data-sizes=auto alt=/guloader-deobfuscation-using-ghidra/result.png title=output width=732 height=422></p><p>I Have only Checked one sample with the scripts .Feel free to use it with Other Guloader Shell Code and let me know if you are able to see the Decrypted strings</p><p>File SHA1 : 992d98aa6f31ae6f8f42fac9866a19c2a2f879be</p><h2 id=references>References</h2><ol><li><a href=https://securitynews.sonicwall.com/xmlpost/guloader-demystified-unraveling-its-vectored-exception-handler-approach/ target=_blank rel="noopener noreffer">SonicWall</a></li><li><a href=https://research.checkpoint.com/2023/cloud-based-malware-delivery-the-evolution-of-guloader/ target=_blank rel="noopener noreffer">CheckPoint</a></li><li><a href=https://any.run/cybersecurity-blog/deobfuscating-guloader/ target=_blank rel="noopener noreffer">AnyRun</a></li></ol></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-07-28&nbsp;<a class=git-hash href=https://github.com/dillonzq/LoveIt/commit/cccdcacb66353cc79b2c2c5a45a666cda3cd828b target=_blank title="commit by irfan-eternal(irfan_eternal@proton.me) cccdcacb66353cc79b2c2c5a45a666cda3cd828b: 5th article First  Draft">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>cccdcac</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/guloader-deobfuscation-using-ghidra/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://irfan-eternal.github.io/guloader-deobfuscation-using-ghidra/ data-title="Guloader Deobfuscation using Ghidra" data-via=irfan_eternal><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://irfan-eternal.github.io/guloader-deobfuscation-using-ghidra/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://irfan-eternal.github.io/guloader-deobfuscation-using-ghidra/ data-title="Guloader Deobfuscation using Ghidra"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://irfan-eternal.github.io/guloader-deobfuscation-using-ghidra/ data-title="Guloader Deobfuscation using Ghidra"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://irfan-eternal.github.io/guloader-deobfuscation-using-ghidra/ data-title="Guloader Deobfuscation using Ghidra"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/malware-string-decryption-in-2-ways/ class=prev rel=prev title="Malware String Decryption in 2 ways"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Malware String Decryption in 2 ways</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.115.4">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>irfan_eternal</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>