<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Analysing Shellcode to understand how they call windows API's - irfan_eternal</title><meta name=Description content="Analysing Shellcode to understand how they call windows API's"><meta property="og:title" content="Analysing Shellcode to understand how they call windows API's">
<meta property="og:description" content="Analysing Shellcode to understand how they call windows API's"><meta property="og:type" content="article"><meta property="og:url" content="https://irfan-eternal.github.io/analysing-shellcode-to-understand-how-they-call-windows-apis/"><meta property="og:image" content="https://irfan-eternal.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-28T11:35:00+08:00"><meta property="article:modified_time" content="2024-01-19T11:13:21-05:00"><meta property="og:site_name" content="irfan_eternal"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://irfan-eternal.github.io/logo.png"><meta name=twitter:title content="Analysing Shellcode to understand how they call windows API's"><meta name=twitter:description content="Analysing Shellcode to understand how they call windows API's"><meta name=twitter:site content="@irfan_eternal"><meta name=application-name content="irfan_eternal"><meta name=apple-mobile-web-app-title content="irfan_eternal"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://irfan-eternal.github.io/analysing-shellcode-to-understand-how-they-call-windows-apis/><link rel=prev href=https://irfan-eternal.github.io/improving-my-ghidra-gui--ghidra-skills/><link rel=next href=https://irfan-eternal.github.io/malware-string-decryption-in-2-ways/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Analysing Shellcode to understand how they call windows API's","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/irfan-eternal.github.io\/analysing-shellcode-to-understand-how-they-call-windows-apis\/"},"image":[{"@type":"ImageObject","url":"https:\/\/irfan-eternal.github.io\/images\/Apple-Devices-Preview.png","width":3200,"height":2048}],"genre":"posts","wordcount":256,"url":"https:\/\/irfan-eternal.github.io\/analysing-shellcode-to-understand-how-they-call-windows-apis\/","datePublished":"2022-12-28T11:35:00+08:00","dateModified":"2024-01-19T11:13:21-05:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"irfan_eternal","logo":{"@type":"ImageObject","url":"https:\/\/irfan-eternal.github.io\/images\/avatar.png","width":400,"height":400}},"author":{"@type":"Person","name":"irfan_eternal"},"description":"Analysing Shellcode to understand how they call windows API's"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=irfan_eternal>irfan_eternal</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About Me </a><a class=menu-item href=https://github.com/irfan-eternal title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><a class=menu-item href=/></a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=irfan_eternal>irfan_eternal</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About Me</a><a class=menu-item href=https://github.com/irfan-eternal title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a class=menu-item href=/ title></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Analysing Shellcode to understand how they call windows API's</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://twitter.com/irfan_eternal title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>irfan_eternal</a></span>&nbsp;<span class=post-category>included in <a href=/categories/reverse-engineering/><i class="far fa-folder fa-fw" aria-hidden=true></i>Reverse Engineering</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2022-12-28>2022-12-28</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;256 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;2 minutes&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/analysing-shellcode-to-understand-how-they-call-windows-apis/shellcode.jpg data-srcset="/analysing-shellcode-to-understand-how-they-call-windows-apis/shellcode.jpg, /analysing-shellcode-to-understand-how-they-call-windows-apis/shellcode.jpg 1.5x, /analysing-shellcode-to-understand-how-they-call-windows-apis/shellcode.jpg 2x" data-sizes=auto alt=/analysing-shellcode-to-understand-how-they-call-windows-apis/shellcode.jpg title="Analysing Shellcode to understand how they call windows API's" width=1024 height=1024></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#analysis>Analysis</a></li><li><a href=#references>References</a></li></ul></nav></div></div><div class=content id=content><p><img class=lazyload src=/svg/loading.min.svg data-src=/analysing-shellcode-to-understand-how-they-call-windows-apis/sc0.png data-srcset="/analysing-shellcode-to-understand-how-they-call-windows-apis/sc0.png, /analysing-shellcode-to-understand-how-they-call-windows-apis/sc0.png 1.5x, /analysing-shellcode-to-understand-how-they-call-windows-apis/sc0.png 2x" data-sizes=auto alt=/analysing-shellcode-to-understand-how-they-call-windows-apis/sc0.png title="image peb" width=567 height=347></p><h2 id=introduction>Introduction</h2><p>Hi all, Today we will be Analysing Shellcode to understand how they call windows API&rsquo;s. shellcode&rsquo;s are position independent, they do not have IAT to call API&rsquo;s. They normally walk the PEB(Process Environment Block).To understand theory on how PEB is used to get API&rsquo;s please read <a href=https://imphash.medium.com/windows-process-internals-a-few-concepts-to-know-before-jumping-on-memory-forensics-part-2-4f45022fb1f8 target=_blank rel="noopener noreffer">this article</a>
We will follow how a malware use this technique to call windows API&rsquo;s .</p><h2 id=analysis>Analysis</h2><p><img class=lazyload src=/svg/loading.min.svg data-src=/analysing-shellcode-to-understand-how-they-call-windows-apis/code1.png data-srcset="/analysing-shellcode-to-understand-how-they-call-windows-apis/code1.png, /analysing-shellcode-to-understand-how-they-call-windows-apis/code1.png 1.5x, /analysing-shellcode-to-understand-how-they-call-windows-apis/code1.png 2x" data-sizes=auto alt=/analysing-shellcode-to-understand-how-they-call-windows-apis/code1.png title="shellcode copied" width=923 height=517>
The malware First allocates memory and copies the shellcode from the rsrc section to the allocated memory</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/analysing-shellcode-to-understand-how-they-call-windows-apis/shell2.png data-srcset="/analysing-shellcode-to-understand-how-they-call-windows-apis/shell2.png, /analysing-shellcode-to-understand-how-they-call-windows-apis/shell2.png 1.5x, /analysing-shellcode-to-understand-how-they-call-windows-apis/shell2.png 2x" data-sizes=auto alt=/analysing-shellcode-to-understand-how-they-call-windows-apis/shell2.png title="walking the peb" width=797 height=252>
Then it gets the TEB (fs[18]) , after that it uses TEB to get the PEB (fs[30]). from the PEB it gets PEB_LDR_DATA ([PEB]+0c). from PEB_LDR_DATA it gets InInitilizationOrderModuleList([PEB_LDR_DATA] + 1c). Then it gets the BsaeDLL name to check if 10th char is &ldquo;.&rdquo; (for detecting kernel32.dll).This Data strucure is called LDR_DATA_TABLE_ENTRY. this table also contains other important Data like DLLBase, Entrypoint, SizeOfImage. To understand more about this Structures i would ask you to read <a href=https://securitycafe.ro/2015/12/14/introduction-to-windows-shellcode-development-part-2/ target=_blank rel="noopener noreffer">this article</a>
<img class=lazyload src=/svg/loading.min.svg data-src=/analysing-shellcode-to-understand-how-they-call-windows-apis/shell6.png data-srcset="/analysing-shellcode-to-understand-how-they-call-windows-apis/shell6.png, /analysing-shellcode-to-understand-how-they-call-windows-apis/shell6.png 1.5x, /analysing-shellcode-to-understand-how-they-call-windows-apis/shell6.png 2x" data-sizes=auto alt=/analysing-shellcode-to-understand-how-they-call-windows-apis/shell6.png title=Structures width=707 height=828></p><p>After getting the DLLBase, we can get to e_lfanew(DLLbase+3c). From there we can go to the Exports Directory (DLLbase+ e_lfanew + 78).Exports Directory contains data Like Address of names,Address of functions,Address of named ordinals,Number of names. These Data are used to Hash all the API"s and see if it Matches. You can refer <a href=http://www.sunshine2k.de/reversing/tuts/tut_pe.htm target=_blank rel="noopener noreffer">this site</a> to learn more about PE File format offsets</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/analysing-shellcode-to-understand-how-they-call-windows-apis/shell3.png data-srcset="/analysing-shellcode-to-understand-how-they-call-windows-apis/shell3.png, /analysing-shellcode-to-understand-how-they-call-windows-apis/shell3.png 1.5x, /analysing-shellcode-to-understand-how-they-call-windows-apis/shell3.png 2x" data-sizes=auto alt=/analysing-shellcode-to-understand-how-they-call-windows-apis/shell3.png title="Getting Data of API hash " width=752 height=312></p><p>An example of malware which uses the hashes of LoadLibraryExW and GetProcAddress to resolve them can be seen below</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/analysing-shellcode-to-understand-how-they-call-windows-apis/code4.png data-srcset="/analysing-shellcode-to-understand-how-they-call-windows-apis/code4.png, /analysing-shellcode-to-understand-how-they-call-windows-apis/code4.png 1.5x, /analysing-shellcode-to-understand-how-they-call-windows-apis/code4.png 2x" data-sizes=auto alt=/analysing-shellcode-to-understand-how-they-call-windows-apis/code4.png title="LoadLibrary &amp;amp; GetProcAddress" width=843 height=558></p><p>After this stack strings of DLL&rsquo;s are created and loaded using LoadlibraryExW</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/analysing-shellcode-to-understand-how-they-call-windows-apis/code5.png data-srcset="/analysing-shellcode-to-understand-how-they-call-windows-apis/code5.png, /analysing-shellcode-to-understand-how-they-call-windows-apis/code5.png 1.5x, /analysing-shellcode-to-understand-how-they-call-windows-apis/code5.png 2x" data-sizes=auto alt=/analysing-shellcode-to-understand-how-they-call-windows-apis/code5.png title=Stackstrings width=806 height=803></p><h2 id=references>References</h2><ol><li><a href=https://imphash.medium.com/windows-process-internals-a-few-concepts-to-know-before-jumping-on-memory-forensics-part-2-4f45022fb1f8 target=_blank rel="noopener noreffer">imphash</a></li><li><a href=https://securitycafe.ro/2015/12/14/introduction-to-windows-shellcode-development-part-2/ target=_blank rel="noopener noreffer">securitycafe</a></li><li><a href=http://www.sunshine2k.de/reversing/tuts/tut_pe.htm target=_blank rel="noopener noreffer">sunshine2k.</a></li></ol></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2024-01-19&nbsp;<a class=git-hash href=https://github.com/dillonzq/LoveIt/commit/431f86954945a8e540bda278dd71e3e4d1e9db30 target=_blank title="commit by irfan-eternal(irfan_eternal@proton.me) 431f86954945a8e540bda278dd71e3e4d1e9db30: 7th article First  Draft">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>431f869</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/analysing-shellcode-to-understand-how-they-call-windows-apis/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://irfan-eternal.github.io/analysing-shellcode-to-understand-how-they-call-windows-apis/ data-title="Analysing Shellcode to understand how they call windows API's" data-via=irfan_eternal><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://irfan-eternal.github.io/analysing-shellcode-to-understand-how-they-call-windows-apis/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://irfan-eternal.github.io/analysing-shellcode-to-understand-how-they-call-windows-apis/ data-title="Analysing Shellcode to understand how they call windows API's"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://irfan-eternal.github.io/analysing-shellcode-to-understand-how-they-call-windows-apis/ data-title="Analysing Shellcode to understand how they call windows API's"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://irfan-eternal.github.io/analysing-shellcode-to-understand-how-they-call-windows-apis/ data-title="Analysing Shellcode to understand how they call windows API's" data-image=shellcode.jpg><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/improving-my-ghidra-gui--ghidra-skills/ class=prev rel=prev title="Improving My Ghidra GUI + Ghidra Skills"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Improving My Ghidra GUI + Ghidra Skills</a>
<a href=/malware-string-decryption-in-2-ways/ class=next rel=next title="Malware String Decryption in 2 ways">Malware String Decryption in 2 ways<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.121.2">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>irfan_eternal</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>