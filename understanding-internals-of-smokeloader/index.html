<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Understanding Internals of SmokeLoader - irfan_eternal</title><meta name=Description content="Understanding Internals of SmokeLoader"><meta property="og:title" content="Understanding Internals of SmokeLoader">
<meta property="og:description" content="Understanding Internals of SmokeLoader"><meta property="og:type" content="article"><meta property="og:url" content="https://irfan-eternal.github.io/understanding-internals-of-smokeloader/"><meta property="og:image" content="https://irfan-eternal.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-06T11:35:00+08:00"><meta property="article:modified_time" content="2024-01-19T11:19:00-05:00"><meta property="og:site_name" content="irfan_eternal"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://irfan-eternal.github.io/logo.png"><meta name=twitter:title content="Understanding Internals of SmokeLoader"><meta name=twitter:description content="Understanding Internals of SmokeLoader"><meta name=twitter:site content="@irfan_eternal"><meta name=application-name content="irfan_eternal"><meta name=apple-mobile-web-app-title content="irfan_eternal"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://irfan-eternal.github.io/understanding-internals-of-smokeloader/><link rel=prev href=https://irfan-eternal.github.io/analysing-.net-asyncrat-using-dnspy/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Understanding Internals of SmokeLoader","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/irfan-eternal.github.io\/understanding-internals-of-smokeloader\/"},"image":[{"@type":"ImageObject","url":"https:\/\/irfan-eternal.github.io\/images\/Apple-Devices-Preview.png","width":3200,"height":2048}],"genre":"posts","wordcount":3020,"url":"https:\/\/irfan-eternal.github.io\/understanding-internals-of-smokeloader\/","datePublished":"2024-01-06T11:35:00+08:00","dateModified":"2024-01-19T11:19:00-05:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"irfan_eternal","logo":{"@type":"ImageObject","url":"https:\/\/irfan-eternal.github.io\/images\/avatar.png","width":400,"height":400}},"author":{"@type":"Person","name":"irfan_eternal"},"description":"Understanding Internals of SmokeLoader"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=irfan_eternal>irfan_eternal</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About Me </a><a class=menu-item href=https://github.com/irfan-eternal title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><a class=menu-item href=/></a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=irfan_eternal>irfan_eternal</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About Me</a><a class=menu-item href=https://github.com/irfan-eternal title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a class=menu-item href=/ title></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Understanding Internals of SmokeLoader</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://twitter.com/irfan_eternal title=Author target=_blank rel="noopener noreffer author" class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>irfan_eternal</a></span>&nbsp;<span class=post-category>included in <a href=/categories/malware-analysis/><i class="far fa-folder fa-fw" aria-hidden=true></i>Malware Analysis</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2024-01-06>2024-01-06</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;3020 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;15 minutes&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/smokeloader.jpg data-srcset="/understanding-internals-of-smokeloader/smokeloader.jpg, /understanding-internals-of-smokeloader/smokeloader.jpg 1.5x, /understanding-internals-of-smokeloader/smokeloader.jpg 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/smokeloader.jpg title="Understanding Internals of SmokeLoader" width=1024 height=1024></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#analysis>Analysis</a></li><li><a href=#stage-1>Stage 1</a><ul><li><a href=#shellcode-allocation-and-calling>Shellcode Allocation and Calling</a></li><li><a href=#loading-new-image-to-memory>Loading New Image to Memory</a></li></ul></li><li><a href=#stage-2>Stage 2</a><ul><li><a href=#weird-conditional-jumps>Weird Conditional Jumps</a></li><li><a href=#control-flow-obfuscation>Control Flow Obfuscation</a></li><li><a href=#encrypted-function-code>Encrypted Function Code</a></li><li><a href=#api-hashing>API Hashing</a></li><li><a href=#checks-keyboard-layout>Checks KeyBoard Layout</a></li><li><a href=#previliges-check>Previliges Check</a></li><li><a href=#api-resolving-for-apis-of-ntdll>API Resolving for APIs of NTDLL</a></li><li><a href=#anti-sandbox-anti-emulator-and-anti-vm-techniques>Anti-Sandbox, Anti-Emulator and Anti-VM Techniques</a></li><li><a href=#injection-of-third-stage-using-heavens-gate-technique>Injection of Third Stage using Heavens Gate Technique</a></li></ul></li><li><a href=#stage-3>Stage 3</a><ul><li><a href=#dynamic-api-resolving-using-api-hashing>Dynamic API Resolving using API Hashing</a></li><li><a href=#encrypted-strings>Encrypted Strings</a></li><li><a href=#analysis-tools-check>Analysis Tools Check</a></li><li><a href=#previliges-check-1>Previliges Check</a></li><li><a href=#mutex-check>Mutex Check</a></li><li><a href=#copy-to-new-path-and-use-of-zoneidentifier>Copy to New Path and use of Zone.Identifier</a></li><li><a href=#changing-file-attributes-and-filetime>Changing File Attributes and FileTime</a></li><li><a href=#persistance>Persistance</a></li><li><a href=#c2-decryption-and-communication>C2 Decryption and Communication</a></li></ul></li><li><a href=#indicators-of-compromise>Indicators of Compromise</a></li><li><a href=#references>References</a></li></ul></nav></div></div><div class=content id=content><h2 id=introduction>Introduction</h2><p>In this blog we will be discussing about Understanding Internals of SmokeLoader using Ghidra</p><h2 id=analysis>Analysis</h2><p>For readers who want to Follow along can get the sample from <a href=https://bazaar.abuse.ch/sample/5c1735b8154391534f98e6399a2576a572c7fd3c51fa6ecc097434c89053b1f7/ target=_blank rel="noopener noreffer">MalwareBazaar</a> .The sample was first Seen on September 5th 2023 14:12:29 UTC
. The sample is 32bit Exe File You can use the tool of your Choice i will be using Ghidra in this blog. The Sample Consists of 3 Stages. In the next sections we will look at each Stages in Detail</p><h2 id=stage-1>Stage 1</h2><p>The Primary Job of Stage 1 is to Write a new Image to Memory which is the Second Stage</p><h3 id=shellcode-allocation-and-calling>Shellcode Allocation and Calling</h3><p>The Stage 1 Allocates a Executable Memory in Virtual address space using VirtualAlloc. Writes Shellcode to this address space whose job is to Load the new Image in to Memory
<img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage1shellcodeAlloc.PNG data-srcset="/understanding-internals-of-smokeloader/stage1shellcodeAlloc.PNG, /understanding-internals-of-smokeloader/stage1shellcodeAlloc.PNG 1.5x, /understanding-internals-of-smokeloader/stage1shellcodeAlloc.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage1shellcodeAlloc.PNG title=stage1shellcodeAlloc.PNG width=1527 height=624>
It Calls the Shellcode from Address <strong>40404a</strong> If you want to Dump this Shellcode and Understand What it is doing you Can put a Breakpoint on this Location . Stepin to this Call and dump this portion or Follow it in Debugger to Understand What it&rsquo;s doing
<img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage1ShellcodeCalling.PNG data-srcset="/understanding-internals-of-smokeloader/stage1ShellcodeCalling.PNG, /understanding-internals-of-smokeloader/stage1ShellcodeCalling.PNG 1.5x, /understanding-internals-of-smokeloader/stage1ShellcodeCalling.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage1ShellcodeCalling.PNG title=stage1ShellcodeCalling.PNG width=1535 height=614></p><h3 id=loading-new-image-to-memory>Loading New Image to Memory</h3><p>The Shellcode first Dynamically Resolves API Call. It uses StackStrings and GetProcAddress to do this
<img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage1dynamicApiresolvinngsingStackstringsandgetptocAddress.PNG data-srcset="/understanding-internals-of-smokeloader/stage1dynamicApiresolvinngsingStackstringsandgetptocAddress.PNG, /understanding-internals-of-smokeloader/stage1dynamicApiresolvinngsingStackstringsandgetptocAddress.PNG 1.5x, /understanding-internals-of-smokeloader/stage1dynamicApiresolvinngsingStackstringsandgetptocAddress.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage1dynamicApiresolvinngsingStackstringsandgetptocAddress.PNG title=stage1dynamicApiresolvinngsingStackstringsandgetptocAddress.PNG width=1630 height=616>
Using the Dynamically Resolved API Calls it Loads the New Image to Memory by Parsing PE Headers. If you have a good Understaing of PE File Formats and it&rsquo;s offsets the below image will make Sense to you
<img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage1loadstage2tomemorybyparsingpeheader.PNG data-srcset="/understanding-internals-of-smokeloader/stage1loadstage2tomemorybyparsingpeheader.PNG, /understanding-internals-of-smokeloader/stage1loadstage2tomemorybyparsingpeheader.PNG 1.5x, /understanding-internals-of-smokeloader/stage1loadstage2tomemorybyparsingpeheader.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage1loadstage2tomemorybyparsingpeheader.PNG title=stage1loadstage2tomemorybyparsingpeheader.PNG width=746 height=625></p><p>Some PE File Format offsets i want you take a note is 0x3c and 0x78 . Offset 0x3c is aslo called as e_lfanew it is the File address of new exe header .e_lfanew* + 0x78 gives us the ExportDirectory Virtual Address</p><p>After this Shellcode is Comletely executed the New Image will be Loaded in the Memory. You can dump the Second stage from memory Now</p><h2 id=stage-2>Stage 2</h2><p>Stage 2 is Very Obfuscated Stage with Multiple Anti-Analysis Techniques to Frustrate the Malware Analyst working on it. It Includes Anti-Vm Checks, Encrypted Function code only Decrypted prior to it&rsquo;s execution, API Hashing etc&mldr; The Final Goal of this Stage is to Inject the Third Stage to explorer.exe</p><h3 id=weird-conditional-jumps>Weird Conditional Jumps</h3><p>This Stage Contains Weird Conditional Jumps as Show in the below image . They are JNZ and JZ jumps with same Destination Address. This is Infact an Unconditional Jump. The Malware is using this technique make it hard for the Disassembler and Decompiler</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage2beforefixingwierduncondjumps.PNG data-srcset="/understanding-internals-of-smokeloader/stage2beforefixingwierduncondjumps.PNG, /understanding-internals-of-smokeloader/stage2beforefixingwierduncondjumps.PNG 1.5x, /understanding-internals-of-smokeloader/stage2beforefixingwierduncondjumps.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage2beforefixingwierduncondjumps.PNG title=stage2beforefixingwierduncondjumps.PNG width=541 height=609></p><p>We can Fix this Easily by finding all the Places with this weird Conditional Jumps and patching it with unconditional Jump.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>def handleDoubleConditionalJumps():
</span></span><span class=line><span class=cl>    address_array = findBytes(currentProgram.getMinAddress(), b&#39;\x75.\x74.&#39;, 1000)
</span></span><span class=line><span class=cl>    address_array += findBytes(currentProgram.getMinAddress(), b&#39;\x74.\x75.&#39;, 1000)
</span></span><span class=line><span class=cl>    for addr in address_array:
</span></span><span class=line><span class=cl>        jmp_bytes = getBytes(addr, 4)
</span></span><span class=line><span class=cl>        if jmp_bytes[1] - jmp_bytes[3] == 2:
</span></span><span class=line><span class=cl>            clearListing(addr)
</span></span><span class=line><span class=cl>            dis.disassemble(addr, None)
</span></span><span class=line><span class=cl>            patch_instruction = bytearray()
</span></span><span class=line><span class=cl>            patch_instruction.append(0xeb)
</span></span><span class=line><span class=cl>            patch_instruction.append(jmp_bytes[1])
</span></span><span class=line><span class=cl>            patch_instruction.append(0x90)
</span></span><span class=line><span class=cl>            patch_instruction.append(0x90)
</span></span><span class=line><span class=cl>            patch_instruction2 = bytes(patch_instruction)
</span></span><span class=line><span class=cl>            clearListing(addr)
</span></span><span class=line><span class=cl>            clearListing(addr.add(2))
</span></span><span class=line><span class=cl>            clearListing(addr.add(3))
</span></span><span class=line><span class=cl>            block = mem.getBlock(addr)
</span></span><span class=line><span class=cl>            block.putBytes(addr,patch_instruction2 )
</span></span><span class=line><span class=cl>            dis.disassemble(addr, None)
</span></span><span class=line><span class=cl>            jmp_instr = getInstructionAt(addr)
</span></span><span class=line><span class=cl>            new_jmp = jmp_instr.getDefaultFlows()[0]
</span></span><span class=line><span class=cl>            new_jmp2 = new_jmp
</span></span><span class=line><span class=cl>            for i in range(50):
</span></span><span class=line><span class=cl>                 clearListing(new_jmp2)
</span></span><span class=line><span class=cl>                 new_jmp2 = new_jmp2.add(1)
</span></span><span class=line><span class=cl>                 if new_jmp2.getAddress == currentProgram.getMaxAddress():
</span></span><span class=line><span class=cl>                     break
</span></span></code></pre></td></tr></table></div></div><p>The Above Python Code does this using Ghidra API After we run this Script all the Weird Conditonal Jumps will be patched to Unconditional jumps and Disasseblers and Decompilera will give us a Better Output. The Below images Shows us the Sample after Execution of th Script
<img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage2afterfixingwierduncondjumps.PNG data-srcset="/understanding-internals-of-smokeloader/stage2afterfixingwierduncondjumps.PNG, /understanding-internals-of-smokeloader/stage2afterfixingwierduncondjumps.PNG 1.5x, /understanding-internals-of-smokeloader/stage2afterfixingwierduncondjumps.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage2afterfixingwierduncondjumps.PNG title=stage2afterfixingwierduncondjumps.PNG width=538 height=594></p><h3 id=control-flow-obfuscation>Control Flow Obfuscation</h3><p>This stage&rsquo;s Control Flow is Obfuscated with the use of Anti-Debugging Checks</p><p>In the Below Image malware uses PEB&rsquo;s BeingDebugged Field (Offset 0x2) to Check if Process is Being Debugged. If it&rsquo;s not being Debugged the Offset will contain 0, which is used to Calculate the address where the Control flow is Transfered. If the process is being Debugged the Offset will Contain 1 and will lead to Exception</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage2_controlflatobfuscation_being_debugged.PNG data-srcset="/understanding-internals-of-smokeloader/stage2_controlflatobfuscation_being_debugged.PNG, /understanding-internals-of-smokeloader/stage2_controlflatobfuscation_being_debugged.PNG 1.5x, /understanding-internals-of-smokeloader/stage2_controlflatobfuscation_being_debugged.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage2_controlflatobfuscation_being_debugged.PNG title=stage2_controlflatobfuscation_being_debugged.PNG width=758 height=288></p><p>An other Anti-Deugging Technique it uses is the NtGlobalFlag Field( offset 0x68) in the PEB to Check if it&rsquo;s Being Debugged. If it&rsquo;s not being Debugged the Offset will contain 0, which is used to Calculate the address where the Control flow is Transfered. If the process is being Debugged the Offset will Contain 0x70 and will lead to Exception</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage2_controlflatobfuscation_ntglobal.PNG data-srcset="/understanding-internals-of-smokeloader/stage2_controlflatobfuscation_ntglobal.PNG, /understanding-internals-of-smokeloader/stage2_controlflatobfuscation_ntglobal.PNG 1.5x, /understanding-internals-of-smokeloader/stage2_controlflatobfuscation_ntglobal.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage2_controlflatobfuscation_ntglobal.PNG title=stage2_controlflatobfuscation_ntglobal.PNG width=739 height=200></p><h3 id=encrypted-function-code>Encrypted Function Code</h3><p>One of the most distinctive feature about SmokeLoader is that most of the Function code are in the Encrypted form. They will only be Decrypted just before execution of that code. And will be re-encrypted after that code has been executed</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage2BeofreFunctionDecryption.PNG data-srcset="/understanding-internals-of-smokeloader/stage2BeofreFunctionDecryption.PNG, /understanding-internals-of-smokeloader/stage2BeofreFunctionDecryption.PNG 1.5x, /understanding-internals-of-smokeloader/stage2BeofreFunctionDecryption.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage2BeofreFunctionDecryption.PNG title=stage2BeofreFunctionDecryption.PNG width=1554 height=628></p><p>The above image show an Example how the Code look like before Encryption</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage2functionDecryption.PNG data-srcset="/understanding-internals-of-smokeloader/stage2functionDecryption.PNG, /understanding-internals-of-smokeloader/stage2functionDecryption.PNG 1.5x, /understanding-internals-of-smokeloader/stage2functionDecryption.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage2functionDecryption.PNG title=stage2functionDecryption.PNG width=577 height=351></p><p>The decryption_function in the above image is the function which decrypts the Code. It is a normal XOR Decrption. The Function takes three parameters.</p><ol><li>Size of the code to be decrypted</li><li>XOR Key used</li><li>RVA of the Starting of the Code that need to be decrypted. You can use the below function to Decrypt one function at a time</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>def decryptShellcode(size, xor_key, rva):
</span></span><span class=line><span class=cl>    va = rva + 0x400000
</span></span><span class=line><span class=cl>    va = hex(va)[2:]
</span></span><span class=line><span class=cl>    addr = toAddr(va)
</span></span><span class=line><span class=cl>    addr2 = addr
</span></span><span class=line><span class=cl>    enc = get_bytes(toAddr(va), size)
</span></span><span class=line><span class=cl>    for i in range(size):
</span></span><span class=line><span class=cl>            clearListing(addr2)
</span></span><span class=line><span class=cl>            addr2 = addr2.add(1)
</span></span><span class=line><span class=cl>    size2 = size
</span></span><span class=line><span class=cl>    for i in range(0,size):
</span></span><span class=line><span class=cl>        enc[i] = enc[i]^xor_key
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>    for i in enc:
</span></span><span class=line><span class=cl>       i = i &amp; 0xFF
</span></span><span class=line><span class=cl>       setByte(addr, i)
</span></span><span class=line><span class=cl>       addr = addr.add(1)
</span></span></code></pre></td></tr></table></div></div><p>The Below Image Shows the same code after Decryption. The last call to 40131a is wrapper for decryption_function, which will cause the code to be re-encrypted
<img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage2AfterFunctionDecryption.PNG data-srcset="/understanding-internals-of-smokeloader/stage2AfterFunctionDecryption.PNG, /understanding-internals-of-smokeloader/stage2AfterFunctionDecryption.PNG 1.5x, /understanding-internals-of-smokeloader/stage2AfterFunctionDecryption.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage2AfterFunctionDecryption.PNG title=stage2AfterFunctionDecryption.PNG width=1404 height=612></p><h3 id=api-hashing>API Hashing</h3><p>The Hashing Algorithm used in 2nd Stage is DJB2 hasing Algorithm. In the below image you can see the decompiled code for this. If you are having trouble Understanding this Code i would ask you to read <a href=https://irfan-eternal.github.io/analysing-shellcode-to-understand-how-they-call-windows-apis/ target=_blank rel="noopener noreffer">this blog</a> . It Explains in Detail about API Resolving</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage2dbj2Hashing.PNG data-srcset="/understanding-internals-of-smokeloader/stage2dbj2Hashing.PNG, /understanding-internals-of-smokeloader/stage2dbj2Hashing.PNG 1.5x, /understanding-internals-of-smokeloader/stage2dbj2Hashing.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage2dbj2Hashing.PNG title=stage2dbj2Hashing.PNG width=722 height=622></p><p>You can use the below python function to find the values of hashes of the API&rsquo;s you need.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>def api_hashing():
</span></span><span class=line><span class=cl>    api_list = []
</span></span><span class=line><span class=cl>    hasher = 0x1505
</span></span><span class=line><span class=cl>    hash2 = 0
</span></span><span class=line><span class=cl>    for a in api_list:
</span></span><span class=line><span class=cl>            hasher = 0x1505
</span></span><span class=line><span class=cl>            hash2 = 0
</span></span><span class=line><span class=cl>            for i in a:
</span></span><span class=line><span class=cl>                i = ord(i)
</span></span><span class=line><span class=cl>                hash2 = hasher
</span></span><span class=line><span class=cl>                hasher = hasher &lt;&lt; 5
</span></span><span class=line><span class=cl>                hasher = hasher &amp; 0xFFFFFFFF
</span></span><span class=line><span class=cl>                hasher = hasher + hash2
</span></span><span class=line><span class=cl>                hasher = hasher &amp; 0xFFFFFFFF
</span></span><span class=line><span class=cl>                hasher = hasher + i
</span></span><span class=line><span class=cl>                hasher = hasher &amp; 0xFFFFFFFF
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            hash2 = hasher
</span></span><span class=line><span class=cl>            hasher = hasher &lt;&lt; 5
</span></span><span class=line><span class=cl>            hasher = hasher &amp; 0xFFFFFFFF
</span></span><span class=line><span class=cl>            hasher = hasher + hash2
</span></span><span class=line><span class=cl>            hasher = hasher &amp; 0xFFFFFFFF
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>           
</span></span><span class=line><span class=cl>            hasher2 = hex(hasher)[2:-1]
</span></span><span class=line><span class=cl>            if len(hasher2)!= 8:
</span></span><span class=line><span class=cl>                hasher2 = &#34;0&#34;+hasher2
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            print(&#34;API Name : &#34;+a+&#34; Address : &#34;+addresss)
</span></span><span class=line><span class=cl>                    
</span></span></code></pre></td></tr></table></div></div><h3 id=checks-keyboard-layout>Checks KeyBoard Layout</h3><p>Next the malware checks the keyboard layout of the device. If it&rsquo;s Russian(0x419) or Ukranian(0x422) the malware won&rsquo;t do any malicious activites. If this is not the case it continues doing it&rsquo;s Buisness</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage2CheckKeyboard.PNG data-srcset="/understanding-internals-of-smokeloader/stage2CheckKeyboard.PNG, /understanding-internals-of-smokeloader/stage2CheckKeyboard.PNG 1.5x, /understanding-internals-of-smokeloader/stage2CheckKeyboard.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage2CheckKeyboard.PNG title=stage2CheckKeyboard.PNG width=1379 height=636></p><h3 id=previliges-check>Previliges Check</h3><p>The Malware Check if it&rsquo;s running with Higher Previliges using this API Call&rsquo;s OpenProcessToken -> GetTokenInformation(TokenIntegrityLabel) -> GetSidSubAuthority
It is Checking if the Integrity level is above 0x2000 (SECURITY_MANDATORY_MEDIUM_RID )
If the values greater than 0x2000, it is high integrity. If the user is local admin, but a process was executed normaly, you have the medium integrity Level. If the user clicks run as administrator you would have 0x3000.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage2mediumrid.png data-srcset="/understanding-internals-of-smokeloader/stage2mediumrid.png, /understanding-internals-of-smokeloader/stage2mediumrid.png 1.5x, /understanding-internals-of-smokeloader/stage2mediumrid.png 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage2mediumrid.png title=stage2mediumrid.png width=731 height=643></p><p>If this is not the Case it will use Run As Administrator Option to get Higher privileges</p><h3 id=api-resolving-for-apis-of-ntdll>API Resolving for APIs of NTDLL</h3><p>The Malware Then Open&rsquo;s a handle ntdll.dll with shareMode set to 0,Creates a file mapping object for ntdll, Maps a view of this file mapping into the address space of the Malicious process and does API resolving using the Same Hash Algorithm (djb2) in this mapped View. This is to make sure no APIs are being hooked by EDR</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage2ApihashingforNtdllPNG.PNG data-srcset="/understanding-internals-of-smokeloader/stage2ApihashingforNtdllPNG.PNG, /understanding-internals-of-smokeloader/stage2ApihashingforNtdllPNG.PNG 1.5x, /understanding-internals-of-smokeloader/stage2ApihashingforNtdllPNG.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage2ApihashingforNtdllPNG.PNG title=stage2ApihashingforNtdllPNG.PNG width=753 height=541></p><h3 id=anti-sandbox-anti-emulator-and-anti-vm-techniques>Anti-Sandbox, Anti-Emulator and Anti-VM Techniques</h3><p>The Malware has Multiple Checks to detect if it&rsquo;s in a VM or sandbox. In the below Image malware is checking if the dlls sbidedll(Sandboxie), aswhook(Avast) and snxhk(Symantec) are mapped into malicious process address space. These DLLs are related to Sandbox solution or Anti-Virus products, another interesting thing to note is that the arguments are stored in the return adress of the function</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage2antiSandbox.PNG data-srcset="/understanding-internals-of-smokeloader/stage2antiSandbox.PNG, /understanding-internals-of-smokeloader/stage2antiSandbox.PNG 1.5x, /understanding-internals-of-smokeloader/stage2antiSandbox.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage2antiSandbox.PNG title=stage2antiSandbox.PNG width=1556 height=416></p><p>Another check used by the malware is to check in the Registry Tree for device and drivers if it contains anything related to Virtual machines. It Opens the Registry keys SYSTEM\CurrentControlSet\Enum\IDE and SYSTEM\CurrentControlSet\Services\Disk\Enum\SCSI using NtOpenKey and gets and the number and sizes of its subkeys using NtQueryKey</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage2antivm1.PNG data-srcset="/understanding-internals-of-smokeloader/stage2antivm1.PNG, /understanding-internals-of-smokeloader/stage2antivm1.PNG 1.5x, /understanding-internals-of-smokeloader/stage2antivm1.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage2antivm1.PNG title=stage2antivm1.PNG width=1524 height=634></p><p>It then uses NtEnumerateKey to get the information about the subkeys and check if this subkeys contains the strings qemu, virtio, vmware, vbox, xen . These strings are related to Emulators and Virtual Machines</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage2antivm2.PNG data-srcset="/understanding-internals-of-smokeloader/stage2antivm2.PNG, /understanding-internals-of-smokeloader/stage2antivm2.PNG 1.5x, /understanding-internals-of-smokeloader/stage2antivm2.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage2antivm2.PNG title=stage2antivm2.PNG width=1371 height=615></p><p>The Next check it uses is to detect Emulators . It Checks Current Process&rsquo; File path with AFEA.vmt using wcsstr this is a Technique called error-based anti-sandbox check. It is explained in detail by herrcore in <a href="https://www.youtube.com/watch?v=8jckguVRHyI" target=_blank rel="noopener noreffer">this video</a></p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage2AFEA.vmt.PNG data-srcset="/understanding-internals-of-smokeloader/stage2AFEA.vmt.PNG, /understanding-internals-of-smokeloader/stage2AFEA.vmt.PNG 1.5x, /understanding-internals-of-smokeloader/stage2AFEA.vmt.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage2AFEA.vmt.PNG title=stage2AFEA.vmt.PNG width=1244 height=375></p><h3 id=injection-of-third-stage-using-heavens-gate-technique>Injection of Third Stage using Heavens Gate Technique</h3><p>The Malware First Checks if it&rsquo;s running on a 64 bit or 32 bit System by looking at the GS Register because GS is non-zero in Win64 and In a &rsquo;true&rsquo; 32 bit Windows GS is always zero.. If it&rsquo;s running on a 64 bit System it uses Heavens Gate technique .“Heaven&rsquo;s Gate” is a technique used to run a 64-bit code from a 32-bit process, or 32-bit code from a 64-bit process .To know more about this technique I request you to refer <a href=https://0xk4n3ki.github.io/posts/Heavens-Gate-Technique/ target=_blank rel="noopener noreffer">this article</a></p><p>Here it is used to run 64-bit code from a 32-bit process for Injection of the Third Stage. If the System only supports 32 bit it Executes the Code shown in the Below Image</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage2Injection1.PNG data-srcset="/understanding-internals-of-smokeloader/stage2Injection1.PNG, /understanding-internals-of-smokeloader/stage2Injection1.PNG 1.5x, /understanding-internals-of-smokeloader/stage2Injection1.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage2Injection1.PNG title=stage2Injection1.PNG width=742 height=801></p><p>The third Stage is injected to explorer.exe. It uses GetShellWindow and GetWindowThreadProcessId to get the process ID of explorer.exe. It then uses NtOpenProcess and NtDublicateObject to create a duplicate handle for explorer.exe. It then creates a section then Maps the same section to malicious process and explorer.exe. Another section is also created and this process is again repeated. The third stage is then written to this section in the malicious Process. Since explorer.exe also has the same section mapped it will also have the third Stage in it&rsquo;s Memory.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage2injectionx64.PNG data-srcset="/understanding-internals-of-smokeloader/stage2injectionx64.PNG, /understanding-internals-of-smokeloader/stage2injectionx64.PNG 1.5x, /understanding-internals-of-smokeloader/stage2injectionx64.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage2injectionx64.PNG title=stage2injectionx64.PNG width=1500 height=811></p><p>Then RtlCreateUserThread is used to Execute the Malicious third stage from explorer.exe&rsquo;s address space</p><p>if the System supports 64 bit. It Decrpyts the 64 bit code for Injection and uses heaven&rsquo;s gate technique technique to excecute this. The process of Injection is same for Both. In the below images you can see the 64 bit code which dynamically resolves RtlCreateUserThread API and it is then used to Execute the malicious third stage from explorer.exe&rsquo;s address space</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/Stage2x64codeforRtlUserCreate.PNG data-srcset="/understanding-internals-of-smokeloader/Stage2x64codeforRtlUserCreate.PNG, /understanding-internals-of-smokeloader/Stage2x64codeforRtlUserCreate.PNG 1.5x, /understanding-internals-of-smokeloader/Stage2x64codeforRtlUserCreate.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/Stage2x64codeforRtlUserCreate.PNG title=Stage2x64codeforRtlUserCreate.PNG width=1052 height=822></p><p>To get the third stage you can set the GS register to 0 in the debugger at the time of injection, set shareMode to FILE_SHARE_READ (0x00000001) when opening handle to ntdll.dll and defeat all the Anti-Analysis techniques mentioned to get the third Stage in explorer.exe and dump it. You can aslo get the entrypoint of the function if you look at the parameters of the RtlCreateUserThread</p><h2 id=stage-3>Stage 3</h2><p>The Main objective of this stage is to Decrypt C2 URl Communicate to C2 and Download the Final payload. This stage is also responsible for Persistnace of the Malware</p><h3 id=dynamic-api-resolving-using-api-hashing>Dynamic API Resolving using API Hashing</h3><p>Third stage of the malware has a Different set of API resolving . it uses ROL8 hashing you can see the algorithm in the below image</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage3HashingAlgo.PNG data-srcset="/understanding-internals-of-smokeloader/stage3HashingAlgo.PNG, /understanding-internals-of-smokeloader/stage3HashingAlgo.PNG 1.5x, /understanding-internals-of-smokeloader/stage3HashingAlgo.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage3HashingAlgo.PNG title=stage3HashingAlgo.PNG width=1555 height=520></p><p>It uses this Hashing Algoritm to resolve APIs in multiple DLLs&rsquo; (kernel32, ntdll, user32, advapi32, ole32, winhttp and dnsapi)</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage3Apiresolving.PNG data-srcset="/understanding-internals-of-smokeloader/stage3Apiresolving.PNG, /understanding-internals-of-smokeloader/stage3Apiresolving.PNG 1.5x, /understanding-internals-of-smokeloader/stage3Apiresolving.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage3Apiresolving.PNG title=stage3Apiresolving.PNG width=737 height=629></p><p>You can use the below code to get the Hashes of the APIs used in Third Stage</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>def stage3ApiHashing():
</span></span><span class=line><span class=cl>    api_list = []
</span></span><span class=line><span class=cl>    hasher = 0
</span></span><span class=line><span class=cl>    for api in api_list:
</span></span><span class=line><span class=cl>        hasher = 0
</span></span><span class=line><span class=cl>        for i in api:
</span></span><span class=line><span class=cl>            i = ord(i)
</span></span><span class=line><span class=cl>            i =  i &amp; 0xdf
</span></span><span class=line><span class=cl>            saved_val = i
</span></span><span class=line><span class=cl>            hasher = hasher ^ saved_val
</span></span><span class=line><span class=cl>            hasher = rol(hasher, 8)
</span></span><span class=line><span class=cl>            hasher  =  hasher &amp; 0xFFFFFFFF
</span></span><span class=line><span class=cl>            hasher  = hasher + saved_val
</span></span><span class=line><span class=cl>            hasher  =  hasher &amp; 0xFFFFFFFF
</span></span><span class=line><span class=cl>        hasher  =  hasher ^ 0x38127ba6
</span></span><span class=line><span class=cl>        hasher  =  hasher &amp; 0xFFFFFFFF
</span></span><span class=line><span class=cl>        print(hex(hasher))
</span></span><span class=line><span class=cl>        hasher2 = hex(hasher)[2:-1]
</span></span><span class=line><span class=cl>        while len(hasher2)!= 8:
</span></span><span class=line><span class=cl>            hasher2 = &#34;0&#34;+hasher2
</span></span><span class=line><span class=cl>        print(api+&#34; : &#34;+hex(hasher))            
</span></span><span class=line><span class=cl>        
</span></span></code></pre></td></tr></table></div></div><h3 id=encrypted-strings>Encrypted Strings</h3><p>The Important Strings in the third Stage are Encrypted in a custom rc4 encryption algorithm. The Encrypted string is Stored in the Format of DataSize:Data</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage3stringdec.PNG data-srcset="/understanding-internals-of-smokeloader/stage3stringdec.PNG, /understanding-internals-of-smokeloader/stage3stringdec.PNG 1.5x, /understanding-internals-of-smokeloader/stage3stringdec.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage3stringdec.PNG title=stage3stringdec.PNG width=639 height=545></p><p>When it Comes to the custom rc4 algorithm. The key Stream Generation is Different from the default rc4 algorithm the below image shows the decompiled view of the custom rc4 decryption algorithm</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage3Customrc4.PNG data-srcset="/understanding-internals-of-smokeloader/stage3Customrc4.PNG, /understanding-internals-of-smokeloader/stage3Customrc4.PNG 1.5x, /understanding-internals-of-smokeloader/stage3Customrc4.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage3Customrc4.PNG title=stage3Customrc4.PNG width=661 height=637></p><p>I Have Converted it to python Here is the code to Decrypt the Strings</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>def key_scheduling(key):
</span></span><span class=line><span class=cl>    sched = [i for i in range(0, 256)]
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    i = 0
</span></span><span class=line><span class=cl>    for j in range(0, 256):
</span></span><span class=line><span class=cl>        i = (i + sched[j] + key[j % len(key)]) % 256
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        tmp = sched[j]
</span></span><span class=line><span class=cl>        sched[j] = sched[i]
</span></span><span class=line><span class=cl>        sched[i] = tmp 
</span></span><span class=line><span class=cl>    return sched
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>def streamXor(data, key, data_len,key_len, shed): 
</span></span><span class=line><span class=cl>    counter = 0
</span></span><span class=line><span class=cl>    i = 0
</span></span><span class=line><span class=cl>    j = i
</span></span><span class=line><span class=cl>    while data_len != 0:
</span></span><span class=line><span class=cl>      i = i+1
</span></span><span class=line><span class=cl>      i = i &amp; 0XFF
</span></span><span class=line><span class=cl>      temp = shed[i]
</span></span><span class=line><span class=cl>      temp = temp &amp; 0xFF
</span></span><span class=line><span class=cl>      j = j + temp
</span></span><span class=line><span class=cl>      j = j &amp; 0xFF
</span></span><span class=line><span class=cl>      shed[i]  = shed[j]
</span></span><span class=line><span class=cl>      shed[j] = temp
</span></span><span class=line><span class=cl>      shed_swap = shed[i] + temp
</span></span><span class=line><span class=cl>      shed_swap = shed_swap &amp; 0xFF
</span></span><span class=line><span class=cl>      data[counter] = data[counter] ^ shed[shed_swap]
</span></span><span class=line><span class=cl>      counter = counter +1
</span></span><span class=line><span class=cl>      data_len = data_len -1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    return data
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>def customrc4(data, key, data_len,key_len):
</span></span><span class=line><span class=cl>    shed = key_scheduling(key)
</span></span><span class=line><span class=cl>    final_result = streamXor(data, key, data_len,key_len, shed)
</span></span><span class=line><span class=cl>    print(final_result)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>def main():
</span></span><span class=line><span class=cl>    data = bytearray(b&#39;\xb2\x16\x17\x9f\x23\x37&#39;)
</span></span><span class=line><span class=cl>    key =  b&#39;\x29\xc5\xbd\xe6&#39;
</span></span><span class=line><span class=cl>    customrc4( data, key, 6, 4)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>main()
</span></span></code></pre></td></tr></table></div></div><p>The Decrypted Strings of the Third Stage can be seen in the Below Image</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/decrypted_string.PNG data-srcset="/understanding-internals-of-smokeloader/decrypted_string.PNG, /understanding-internals-of-smokeloader/decrypted_string.PNG 1.5x, /understanding-internals-of-smokeloader/decrypted_string.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/decrypted_string.PNG title=decrypted_string.PNG width=647 height=722></p><h3 id=analysis-tools-check>Analysis Tools Check</h3><p>This Stage Checks if the system is running Analysis tools by looking at the Process name and Window Class name</p><p>In the Below Image you can see the Malicious process Gettting the Name of all the Processes running, Calculates their Hashes using the algorithm used in Stage 3(ROL8 hashing ) and Check it against Hashes of Analysis tools shown in the image below. If they match, that Process is Terminated</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage3CheckProcessrunning.PNG data-srcset="/understanding-internals-of-smokeloader/stage3CheckProcessrunning.PNG, /understanding-internals-of-smokeloader/stage3CheckProcessrunning.PNG 1.5x, /understanding-internals-of-smokeloader/stage3CheckProcessrunning.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage3CheckProcessrunning.PNG title=stage3CheckProcessrunning.PNG width=1259 height=632></p><p>There is an Additional Check Which get the Class Name of all top-level windows on the screen. It then Calculates their Hashes using the algorithm used in Stage 3(ROL8 hashing ) and Check it against Hashes of Analysis tools shown in the image below. If they Match, the Process related to that window is Terminated</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage3checkwindows.PNG data-srcset="/understanding-internals-of-smokeloader/stage3checkwindows.PNG, /understanding-internals-of-smokeloader/stage3checkwindows.PNG 1.5x, /understanding-internals-of-smokeloader/stage3checkwindows.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage3checkwindows.PNG title=stage3checkwindows.PNG width=1383 height=572></p><h3 id=previliges-check-1>Previliges Check</h3><p>The Same Previliges Check done in Stage 2 is done again Stage 3. The Malware Check if it&rsquo;s running with Higher Prviliges using this API Call&rsquo;s OpenProcessToken->GetTokenInformation(TokenIntegrityLabel)->GetSidSubAuthority
It is Checking if the Integrity level is above 0x2000 (SECURITY_MANDATORY_MEDIUM_RID )
If the values greater than 0x2000, it is high integrity. If the user is local admin, but a process was executed normaly, you have the medium integrity Level. If the user clicks run as administrator you would have 0x3000.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage3MediumridCheck.PNG data-srcset="/understanding-internals-of-smokeloader/stage3MediumridCheck.PNG, /understanding-internals-of-smokeloader/stage3MediumridCheck.PNG 1.5x, /understanding-internals-of-smokeloader/stage3MediumridCheck.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage3MediumridCheck.PNG title=stage3MediumridCheck.PNG width=745 height=557></p><h3 id=mutex-check>Mutex Check</h3><p>The Malware Uses the Computer Name and Volume Infromation to a Create a Formatted Data which is used as a Seed to Create an MD5 Hash with these Values. These Values is used in Multiple Places</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage3seedforrandomvalueofMutex.PNG data-srcset="/understanding-internals-of-smokeloader/stage3seedforrandomvalueofMutex.PNG, /understanding-internals-of-smokeloader/stage3seedforrandomvalueofMutex.PNG 1.5x, /understanding-internals-of-smokeloader/stage3seedforrandomvalueofMutex.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage3seedforrandomvalueofMutex.PNG title=stage3seedforrandomvalueofMutex.PNG width=688 height=521></p><p>One of the most important Place these Value used is to Create a Mutex with this name. The Malware Creates a Mutex with this name and After that uses RtlGetLastWin32Error , if the return value is ERROR_ALREADY_EXIST Malware Exits the Thread. This is done by the malware to make sure the malware is run only once in a System</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/Stage3MutexCheck.PNG data-srcset="/understanding-internals-of-smokeloader/Stage3MutexCheck.PNG, /understanding-internals-of-smokeloader/Stage3MutexCheck.PNG 1.5x, /understanding-internals-of-smokeloader/Stage3MutexCheck.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/Stage3MutexCheck.PNG title=Stage3MutexCheck.PNG width=715 height=595></p><h3 id=copy-to-new-path-and-use-of-zoneidentifier>Copy to New Path and use of Zone.Identifier</h3><p>The Malware Creates a File Path at AppData or Temp . Check if the File running is in this Path. If it is not Running on this path it Delete itself and Copy the File from Curent Location to the File Path Created at AppData or Temp</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage3CopytonewPath.PNG data-srcset="/understanding-internals-of-smokeloader/stage3CopytonewPath.PNG, /understanding-internals-of-smokeloader/stage3CopytonewPath.PNG 1.5x, /understanding-internals-of-smokeloader/stage3CopytonewPath.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage3CopytonewPath.PNG title=stage3CopytonewPath.PNG width=685 height=575></p><p>One Important thing to note here is the Malware Also removes the Alternate Data Stream :Zone.Identifier . It Stores the Data whether the file was downloaded from the Internet. By Doing this System won&rsquo;t Understand the File was downloaded from Internet</p><h3 id=changing-file-attributes-and-filetime>Changing File Attributes and FileTime</h3><p>After Moving the File to Appdata or Temp . The Files Attribute is Changed to 6 ( FILE_ATTRIBUTE_SYSTEM | FILE_ATTRIBUTE_HIDDEN). This makes the File Hidden and operating system uses a part of, or uses this File exclusively.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage3SetFileAttributes.PNG data-srcset="/understanding-internals-of-smokeloader/stage3SetFileAttributes.PNG, /understanding-internals-of-smokeloader/stage3SetFileAttributes.PNG 1.5x, /understanding-internals-of-smokeloader/stage3SetFileAttributes.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage3SetFileAttributes.PNG title=stage3SetFileAttributes.PNG width=776 height=410></p><p>Then Malware Chnages the Malicious Files Creation Time , Last Access Time and Last Write Time to the Creation Time , Last Access Time and Last Write Time of advapi32.dll in System Dir. My Assumption for this Technique is that it is trying to not show it&rsquo;s a New File</p><h3 id=persistance>Persistance</h3><p>The Persistance is Achieved by Creating a Scheduled task using ITaskService interface</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage3Persistance1.PNG data-srcset="/understanding-internals-of-smokeloader/stage3Persistance1.PNG, /understanding-internals-of-smokeloader/stage3Persistance1.PNG 1.5x, /understanding-internals-of-smokeloader/stage3Persistance1.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage3Persistance1.PNG title=stage3Persistance1.PNG width=797 height=819></p><p>First it Deletes the Task with Name FireFox Default Browser Agent{MD5 Value Used to Create Mutex} . Then It Sets Author of the task as Current User. Then Trigger of the task is set when the Current User Logins in. The File path of Task is Set to the Malicious File Copied to AppData or Temp
And It Finally Registers the task with name FireFox Default Browser Agent{MD5 Value Used to Create Mutex}</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage3persistance2.PNG data-srcset="/understanding-internals-of-smokeloader/stage3persistance2.PNG, /understanding-internals-of-smokeloader/stage3persistance2.PNG 1.5x, /understanding-internals-of-smokeloader/stage3persistance2.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage3persistance2.PNG title=stage3Persistance2.PNG width=793 height=812></p><h3 id=c2-decryption-and-communication>C2 Decryption and Communication</h3><p>The C2 URL&rsquo;s are Encrypted using the Same Custom rc4 encryption Algorithm used in Stage3. The Data is also Stored in the Same format DataSize:Data. You can use the Same Decryprtion Function mentioned above to decrypt the Strings</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage3decryptc2URL.PNG data-srcset="/understanding-internals-of-smokeloader/stage3decryptc2URL.PNG, /understanding-internals-of-smokeloader/stage3decryptc2URL.PNG 1.5x, /understanding-internals-of-smokeloader/stage3decryptc2URL.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage3decryptc2URL.PNG title=stage3decryptc2URL.PNG width=787 height=342></p><p>Here is the List of C2 URL&rsquo;s i found in this Malware</p><p><img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/c2url.PNG data-srcset="/understanding-internals-of-smokeloader/c2url.PNG, /understanding-internals-of-smokeloader/c2url.PNG 1.5x, /understanding-internals-of-smokeloader/c2url.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/c2url.PNG title=c2url.PNG width=384 height=138></p><p>The malware then uses the c2 URL with WinHttp Library to Communicate to the C2 server
<img class=lazyload src=/svg/loading.min.svg data-src=/understanding-internals-of-smokeloader/stage3C2Communication.PNG data-srcset="/understanding-internals-of-smokeloader/stage3C2Communication.PNG, /understanding-internals-of-smokeloader/stage3C2Communication.PNG 1.5x, /understanding-internals-of-smokeloader/stage3C2Communication.PNG 2x" data-sizes=auto alt=/understanding-internals-of-smokeloader/stage3C2Communication.PNG title=stage3C2Communication.PNG width=700 height=817></p><p>Since It&rsquo;s a Loader Based on C2 Response It Loads the Final Payload</p><h2 id=indicators-of-compromise>Indicators of Compromise</h2><table><thead><tr><th>Type</th><th>Indicator</th><th>Description</th></tr></thead><tbody><tr><td>SHA256</td><td>5c1735b8154391534f98e6399a2576a572c7fd3c51fa6ecc097434c89053b1f7</td><td>Initial File</td></tr><tr><td>CnC</td><td>hxxp://potunulit[.]org/</td><td>Command and Control</td></tr><tr><td>CnC</td><td>hxxp://hutnilior[.]net/</td><td>Command and Control</td></tr><tr><td>CnC</td><td>hxxp://golilopaster[.]org/</td><td>Command and Control</td></tr><tr><td>CnC</td><td>hxxp://newzelannd66[.]org/</td><td>Command and Control</td></tr></tbody></table><h2 id=references>References</h2><ol><li><a href=https://gist.github.com/hsauers5/491f9dde975f1eaa97103427eda50071 target=_blank rel="noopener noreffer">hsauers5</a></li><li><a href=https://twitter.com/CryptDeriveKey target=_blank rel="noopener noreffer">CryptDeriveKey</a></li><li><a href=https://www.bing.com/images/create target=_blank rel="noopener noreffer">Bing AI Image Generator</a></li></ol></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2024-01-19&nbsp;<a class=git-hash href=https://github.com/dillonzq/LoveIt/commit/e37caac428082a047a62edbab9e094510cf81f2b target=_blank title="commit by irfan-eternal(irfan_eternal@proton.me) e37caac428082a047a62edbab9e094510cf81f2b: 7th article Second  Draft">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>e37caac</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/understanding-internals-of-smokeloader/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://irfan-eternal.github.io/understanding-internals-of-smokeloader/ data-title="Understanding Internals of SmokeLoader" data-via=irfan_eternal><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://irfan-eternal.github.io/understanding-internals-of-smokeloader/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://irfan-eternal.github.io/understanding-internals-of-smokeloader/ data-title="Understanding Internals of SmokeLoader"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://irfan-eternal.github.io/understanding-internals-of-smokeloader/ data-title="Understanding Internals of SmokeLoader"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://irfan-eternal.github.io/understanding-internals-of-smokeloader/ data-title="Understanding Internals of SmokeLoader" data-image=smokeloader.jpg><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/analysing-.net-asyncrat-using-dnspy/ class=prev rel=prev title="Analysing .NET AsyncRAT using dnSpy"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Analysing .NET AsyncRAT using dnSpy</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.121.2">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>irfan_eternal</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>